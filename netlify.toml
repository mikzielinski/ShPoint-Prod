[build]
  base = "apps/client"
  publish = "dist"
  command = "npm --workspace shpoint-client run build"

[build.environment]
  NODE_VERSION = "20"

# Note: Netlify rate limiting cannot be disabled via configuration
# We'll use headers to try to override the limits

# Disable caching for HTML and JS to force fresh builds
[[headers]]
  for = "/*"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"
    X-Build-Version = "v0.4.20"

# Disable Netlify's rate limiting for API calls - CACHE BUST v1.4.4
[[headers]]
  for = "/backend-api/*"
  [headers.values]
    X-RateLimit-Limit = "999999"
    X-RateLimit-Window = "1"
    X-RateLimit-Remaining = "999999"
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"
    X-Cache-Bust = "v1.7.5"

# Disable rate limiting for all API paths - CACHE BUST v1.4.4
[[headers]]
  for = "/api/*"
  [headers.values]
    X-RateLimit-Limit = "999999"
    X-RateLimit-Window = "1"
    X-RateLimit-Remaining = "999999"
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"
    X-Cache-Bust = "v1.7.5"

# Disable rate limiting for auth paths - CACHE BUST v1.4.4
[[headers]]
  for = "/auth/*"
  [headers.values]
    X-RateLimit-Limit = "999999"
    X-RateLimit-Window = "1"
    X-RateLimit-Remaining = "999999"
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"
    X-Cache-Bust = "v1.7.5"

[[redirects]]
  from = "/characters/*.json"
  to = "https://shpoint-prod.onrender.com/characters/:splat"
  status = 200
  force = true

# Redirect /characters/ to React app (not backend)
[[redirects]]
  from = "/characters/"
  to = "/index.html"
  status = 200

[[redirects]]
  from = "/characters_assets/*"
  to = "https://shpoint-prod.onrender.com/characters/:splat"
  status = 200
  force = true

# Special redirect for health endpoint
[[redirects]]
  from = "/backend-api/health"
  to = "https://shpoint-prod.onrender.com/health"
  status = 200
  force = true

[[redirects]]
  from = "/backend-api/*"
  to = "https://shpoint-prod.onrender.com/api/:splat"
  status = 200
  force = true

[[redirects]]
  from = "/backend-auth/*"
  to = "https://shpoint-prod.onrender.com/auth/:splat"
  status = 200
  force = true

# User profile API proxy
[[redirects]]
  from = "/api/user/*"
  to = "https://shpoint-prod.onrender.com/api/user/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

# API v2 proxy - achievements, players, etc.
[[redirects]]
  from = "/api/v2/*"
  to = "https://shpoint-prod.onrender.com/api/v2/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

# API shatterpoint proxy - characters, sets, missions
[[redirects]]
  from = "/api/shatterpoint/*"
  to = "https://shpoint-prod.onrender.com/api/shatterpoint/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

# General API proxy (fallback for other /api/* endpoints)
[[redirects]]
  from = "/api/*"
  to = "https://shpoint-prod.onrender.com/api/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

# Google Search Console verification file - must be served directly
[[redirects]]
  from = "/google29ee34408b7b694e.html"
  to = "/google29ee34408b7b694e.html"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
